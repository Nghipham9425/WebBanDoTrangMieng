IF EXISTS (SELECT name FROM sys.databases WHERE name = 'QLStoreTrangMieng')
    DROP DATABASE QLStoreTrangMieng;

CREATE DATABASE QLStoreTrangMieng;
USE QLStoreTrangMieng;

-- ==========================================
-- DATABASE SCRIPT - Website B√°n B√°nh Tr√°ng Mi·ªáng
-- Phi√™n b·∫£n: 2.0 (ƒê√£ c·∫≠p nh·∫≠t v·ªõi Cart System)
-- ==========================================

CREATE TABLE [User]
(
  UserId INT IDENTITY(1,1) NOT NULL,
  UserName NVARCHAR(100) NOT NULL,
  Email NVARCHAR(255) NOT NULL,
  Password NVARCHAR(255) NOT NULL,
  Role NVARCHAR(20) NOT NULL DEFAULT 'Customer',
  Phone NVARCHAR(20) NULL,
  Address NVARCHAR(500) NULL,
  IsActive BIT DEFAULT 1,
  CreatedDate DATETIME2 DEFAULT GETDATE(),
  PRIMARY KEY (UserId)
);

CREATE TABLE Category
(
  CategoryId INT IDENTITY(1,1) NOT NULL,
  Name NVARCHAR(100) NOT NULL,
  Description NVARCHAR(500) NULL,
  PRIMARY KEY (CategoryId)
);

CREATE TABLE Product
(
  ProductId INT IDENTITY(1,1) NOT NULL,
  Name NVARCHAR(200) NOT NULL,
  Price DECIMAL(10,2) NOT NULL,
  Description NVARCHAR(1000) NULL,
  ImageUrl NVARCHAR(500) NULL,
  StockQuantity INT DEFAULT 0,
  CategoryId INT NOT NULL,
  CreatedDate DATETIME2 DEFAULT GETDATE(),
  PRIMARY KEY (ProductId),
  FOREIGN KEY (CategoryId) REFERENCES Category(CategoryId)
);

CREATE TABLE Promotion
(
  PromotionId INT IDENTITY(1,1) NOT NULL,
  Code NVARCHAR(50) NOT NULL,
  Description NVARCHAR(500) NULL,
  DiscountPercent DECIMAL(5,2) NOT NULL,
  StartDate DATETIME2 NOT NULL,
  EndDate DATETIME2 NOT NULL,
  IsActive BIT DEFAULT 1,
  PRIMARY KEY (PromotionId)
);

CREATE TABLE Product_Promotion
(
  ProductId INT NOT NULL,
  PromotionId INT NOT NULL,
  PRIMARY KEY (ProductId, PromotionId),
  FOREIGN KEY (ProductId) REFERENCES Product(ProductId),
  FOREIGN KEY (PromotionId) REFERENCES Promotion(PromotionId)
);

CREATE TABLE PaymentMethod
(
  PaymentMethodId INT IDENTITY(1,1) NOT NULL,
  MethodName NVARCHAR(50) NOT NULL,
  Description NVARCHAR(200) NULL,
  PRIMARY KEY (PaymentMethodId)
);

CREATE TABLE [Order]
(
  OrderId INT IDENTITY(1,1) NOT NULL,
  OrderDate DATETIME2 DEFAULT GETDATE(),
  ShippingAddress NVARCHAR(500) NOT NULL,
  PaymentMethod NVARCHAR(50) NOT NULL,
  Status NVARCHAR(20) DEFAULT 'Pending',
  UserId INT NOT NULL,
  PRIMARY KEY (OrderId),
  FOREIGN KEY (UserId) REFERENCES [User](UserId)
);

CREATE TABLE Payment
(
  PaymentId INT IDENTITY(1,1) NOT NULL,
  OrderId INT NOT NULL,
  PaymentMethodId INT NOT NULL,
  Amount DECIMAL(10,2) NOT NULL,
  PaymentDate DATETIME2 DEFAULT GETDATE(),
  Status NVARCHAR(20) DEFAULT 'Pending',
  PRIMARY KEY (PaymentId),
  FOREIGN KEY (OrderId) REFERENCES [Order](OrderId),
  FOREIGN KEY (PaymentMethodId) REFERENCES PaymentMethod(PaymentMethodId)
);

CREATE TABLE Order_Product
(
  OrderId INT NOT NULL,
  ProductId INT NOT NULL,
  Quantity INT NOT NULL,
  Price DECIMAL(10,2) NOT NULL,
  PRIMARY KEY (OrderId, ProductId),
  FOREIGN KEY (OrderId) REFERENCES [Order](OrderId),
  FOREIGN KEY (ProductId) REFERENCES Product(ProductId)
);

CREATE TABLE Review
(
  ReviewId INT IDENTITY(1,1) NOT NULL,
  OrderId INT NOT NULL,
  Comment NVARCHAR(1000) NULL,
  Rating INT NOT NULL,
  CreatedDate DATETIME2 DEFAULT GETDATE(),
  PRIMARY KEY (ReviewId),
  FOREIGN KEY (OrderId) REFERENCES [Order](OrderId)
);

-- ==========================================
-- SAMPLE DATA
-- ==========================================

-- Insert Categories
INSERT INTO Category (Name, Description) VALUES 
(N'Tiramisu', N'Tiramisu √ù nguy√™n ch·∫•t c√°c lo·∫°i'), 
(N'Cheesecake', N'B√°nh ph√¥ mai cao c·∫•p'),
(N'Mousse', N'B√°nh mousse m·ªÅm m·ªãn'),
(N'Flan & Pudding', N'B√°nh flan v√† pudding truy·ªÅn th·ªëng'),
(N'Croissant & B√°nh M√¨', N'B√°nh croissant v√† b√°nh m√¨ ng·ªçt'),
(N'C√† Ph√™', N'C√† ph√™ v√† espresso c√°c lo·∫°i'),
(N'Tr√† & Matcha', N'Tr√† v√† matcha latte'),
(N'N∆∞·ªõc U·ªëng ƒê·∫∑c Bi·ªát', N'Smoothie v√† n∆∞·ªõc u·ªëng ƒë·∫∑c ch·∫ø'),
(N'Crochi', N'B√°nh crochi H√†n Qu·ªëc'),
(N'French Toast', N'B√°nh m√¨ n∆∞·ªõng ki·ªÉu Ph√°p');

-- Insert Payment Methods
INSERT INTO PaymentMethod (MethodName, Description) VALUES 
(N'COD', N'Thanh to√°n khi nh·∫≠n h√†ng'),
(N'Bank Transfer', N'Chuy·ªÉn kho·∫£n ng√¢n h√†ng'),
(N'MoMo', N'V√≠ ƒëi·ªán t·ª≠ MoMo'),
(N'VNPay', N'C·ªïng thanh to√°n VNPay'),
(N'Credit Card', N'Th·∫ª t√≠n d·ª•ng/ghi n·ª£');

-- Insert Users
INSERT INTO [User] (UserName, Email, Role, Password, Address, Phone) VALUES 
(N'Administrator', N'admin@trangmieng.com', N'Admin', N'admin123', N'H√† N·ªôi, Vi·ªát Nam', N'0123456789'),
(N'Nguy·ªÖn VƒÉn An', N'customer1@gmail.com', N'Customer', N'123456', N'TP.HCM, Vi·ªát Nam', N'0987654321'),
(N'Tr·∫ßn Th·ªã B√¨nh', N'customer2@gmail.com', N'Customer', N'123456', N'ƒê√† N·∫µng, Vi·ªát Nam', N'0912345678');

-- Insert Products v·ªõi ƒë∆∞·ªùng d·∫´n ·∫£nh th·ª±c t·∫ø
-- TIRAMISU
INSERT INTO Product (Name, Description, Price, CategoryId, StockQuantity, ImageUrl) VALUES 
(N'Tiramisu Original', N'Tiramisu truy·ªÅn th·ªëng v·ªõi h∆∞∆°ng v·ªã c√† ph√™ ƒë·∫≠m ƒë√†, mascarpone m·ªÅm m·ªãn', 65000.00, 1, 30, N'/Content/Images/Products/OriginalTiramisu.png'),
(N'Tiramisu D√¢u T√¢y', N'Tiramisu v·ªõi l·ªõp kem d√¢u t√¢y t∆∞∆°i ng·ªçt thanh', 68000.00, 1, 25, N'/Content/Images/Products/strawBerrytiramisu.png'),
(N'Tiramisu D∆∞a L∆∞·ªõi', N'Tiramisu v·ªõi h∆∞∆°ng v·ªã d∆∞a l∆∞·ªõi m√°t l·∫°nh', 70000.00, 1, 20, N'/Content/Images/Products/MelonTiramisu.png'),
(N'Misu Thi·∫øc', N'Phi√™n b·∫£n ƒë·∫∑c bi·ªát c·ªßa tiramisu v·ªõi l·ªõp kem thi·∫øc', 75000.00, 1, 15, N'/Content/Images/Products/misuThiec_1.jpg'),
(N'Matchamisu', N'Tiramisu matcha Nh·∫≠t B·∫£n v·ªõi h∆∞∆°ng v·ªã tr√† xanh ƒë·∫≠m ƒë√†', 72000.00, 1, 20, N'/Content/Images/Products/matchamisu_1.jpg'),

-- CHEESECAKE
(N'Basque Cheesecake', N'B√°nh ph√¥ mai Basque n∆∞·ªõng ch√°y b·ªÅ m·∫∑t ƒë·∫∑c tr∆∞ng', 85000.00, 2, 25, N'/Content/Images/Products/BasqueCheesecake.png'),

-- MOUSSE
(N'Mousse Blueberry', N'Mousse vi·ªát qu·∫•t v·ªõi l·ªõp kem m·ªãn m√†ng', 58000.00, 3, 30, N'/Content/Images/Products/MousseBlueberry_1.jpg'),
(N'Mousse V·∫£i', N'Mousse v·∫£i thi·ªÅu th∆°m ngon m√°t l·∫°nh', 60000.00, 3, 25, N'/Content/Images/Products/mousseVai_1.jpg'),
(N'Mousse Xo√†i', N'Mousse xo√†i c√°t H√≤a L·ªôc ng·ªçt thanh', 62000.00, 3, 28, N'/Content/Images/Products/MousseXoai_1.jpg'),

-- FLAN & PUDDING
(N'Flan Caramel', N'B√°nh flan caramel truy·ªÅn th·ªëng m·ªÅm m·ªãn', 35000.00, 4, 40, N'/Content/Images/Products/flan_caramel.png'),
(N'Butter Scotch Brulee', N'B√°nh flan b∆° scotch v·ªõi l·ªõp ƒë∆∞·ªùng ch√°y', 45000.00, 4, 30, N'/Content/Images/Products/ButterScotchBrulee.png'),

-- CROISSANT & B√ÅNH M√å
(N'Croissant Chocolate', N'B√°nh s·ª´ng b√≤ nh√¢n chocolate B·ªâ', 42000.00, 5, 35, N'/Content/Images/Products/choco_croissant.jpg'),
(N'Croissant Matcha', N'B√°nh s·ª´ng b√≤ nh√¢n matcha Nh·∫≠t B·∫£n', 45000.00, 5, 30, N'/Content/Images/Products/matcha_croissant.jpg'),

-- C√Ä PH√ä
(N'Americano', N'C√† ph√™ Americano ƒë·∫≠m ƒë√†', 35000.00, 6, 50, N'/Content/Images/Products/Americano.png'),
(N'Cappuccino', N'Cappuccino √ù v·ªõi l·ªõp foam m·ªãn', 42000.00, 6, 45, N'/Content/Images/Products/Capuccino.png'),
(N'Caramel Macchiato', N'Macchiato caramel ng·ªçt ng√†o', 48000.00, 6, 40, N'/Content/Images/Products/CaremelMachiato.png'),
(N'Espresso', N'Espresso nguy√™n ch·∫•t ƒë·∫≠m ƒë√†', 32000.00, 6, 60, N'/Content/Images/Products/Espresso.png'),
(N'Mocha', N'Mocha chocolate ƒë·∫≠m ƒë√†', 45000.00, 6, 35, N'/Content/Images/Products/Mocha.png'),
(N'Vietnamese Milk Coffee', N'C√† ph√™ s·ªØa ƒë√° Vi·ªát Nam truy·ªÅn th·ªëng', 28000.00, 6, 70, N'/Content/Images/Products/VietnameseMilkCoffee.png'),

-- TR√Ä & MATCHA
(N'Matcha Latte', N'Matcha latte Nh·∫≠t B·∫£n nguy√™n ch·∫•t', 52000.00, 7, 35, N'/Content/Images/Products/MatchaLatteS.png'),
(N'Earl Grey With Boba', N'Tr√† Earl Grey v·ªõi tr√¢n ch√¢u', 38000.00, 7, 45, N'/Content/Images/Products/EarlGreyWithBoba.png'),
(N'Gentle Hojicha', N'Tr√† hojicha Nh·∫≠t B·∫£n nh·∫π nh√†ng', 45000.00, 7, 30, N'/Content/Images/Products/gentleHojicha.png'),
(N'Rich Hojicha', N'Tr√† hojicha ƒë·∫≠m ƒë√†', 48000.00, 7, 25, N'/Content/Images/Products/richHojicha.png'),

-- N∆Ø·ªöC U·ªêNG ƒê·∫∂C BI·ªÜT
(N'Matcha Cloud Smoothie', N'Smoothie matcha m√¢y m·ªãn m√†ng', 65000.00, 8, 20, N'/Content/Images/Products/MATCHA-MATCHA-CLOUD-SMOOTHIE-scaled.png'),
(N'Strawberry Lemonade Crush', N'N∆∞·ªõc √©p d√¢u chanh ƒë√° xay', 45000.00, 8, 35, N'/Content/Images/Products/FROZEN-SLUSH-TEA-STRAWBERRY-LEMONADE-CRUSH.png'),
(N'Peach Slush Tea', N'Tr√† ƒë√†o ƒë√° xay m√°t l·∫°nh', 42000.00, 8, 40, N'/Content/Images/Products/FROZEN-SLUSH-TEA-FROSTED-PEACH-SLUSH-TEA.png'),

-- CROCHI
(N'Crochi Chocolate', N'B√°nh crochi nh√¢n chocolate', 35000.00, 9, 40, N'/Content/Images/Products/CROCHI_choco.png'),
(N'Crochi Matcha', N'B√°nh crochi nh√¢n matcha', 38000.00, 9, 35, N'/Content/Images/Products/CROCHI_matcha.png'),
(N'Crochi Strawberry', N'B√°nh crochi nh√¢n d√¢u t√¢y', 38000.00, 9, 35, N'/Content/Images/Products/CROCHI_Strawberry.png'),

-- FRENCH TOAST
(N'Cream Brulee Brioche French Toast', N'B√°nh m√¨ n∆∞·ªõng brioche v·ªõi kem brulee', 75000.00, 10, 20, N'/Content/Images/Products/CreamBruleeBriocheFrenchToasts.png'),
(N'Sweet Bruleed Citrus French Toast', N'B√°nh m√¨ n∆∞·ªõng cam ch√°y ƒë∆∞·ªùng', 72000.00, 10, 22, N'/Content/Images/Products/SWEET-BRULEED-CITRUS-FRENCH-TOAST-scaled.png');

-- Insert Promotions
INSERT INTO Promotion (Code, Description, DiscountPercent, StartDate, EndDate) VALUES 
(N'WELCOME10', N'Gi·∫£m 10% cho kh√°ch h√†ng m·ªõi', 10.00, GETDATE(), DATEADD(MONTH, 3, GETDATE())),
(N'COMBO20', N'Gi·∫£m 20% khi mua combo tr√°ng mi·ªáng + n∆∞·ªõc u·ªëng', 20.00, GETDATE(), DATEADD(MONTH, 1, GETDATE())),
(N'WEEKEND15', N'Gi·∫£m 15% cu·ªëi tu·∫ßn', 15.00, GETDATE(), DATEADD(DAY, 30, GETDATE()));

-- Insert Sample Orders
INSERT INTO [Order] (UserId, ShippingAddress, PaymentMethod, Status) VALUES 
(2, N'123 Nguy·ªÖn Hu·ªá, Qu·∫≠n 1, TP.HCM', N'COD', N'Delivered'),
(3, N'456 Tr·∫ßn Ph√∫, H·∫£i Ch√¢u, ƒê√† N·∫µng', N'MoMo', N'Processing');

-- Insert Order Products
INSERT INTO Order_Product (OrderId, ProductId, Quantity, Price) VALUES 
(1, 1, 2, 65000.00), -- 2 Tiramisu Original
(1, 14, 1, 42000.00), -- 1 Cappuccino
(2, 6, 1, 85000.00), -- 1 Basque Cheesecake
(2, 21, 1, 52000.00); -- 1 Matcha Latte

-- Insert Sample Reviews
INSERT INTO Review (OrderId, Comment, Rating) VALUES 
(1, N'Tiramisu r·∫•t ngon, v·ªã c√† ph√™ ƒë·∫≠m ƒë√†. Cappuccino c≈©ng tuy·ªát v·ªùi!', 5),
(2, N'Basque Cheesecake c√≥ v·ªã r·∫•t ƒë·∫∑c bi·ªát, matcha latte th∆°m ngon.', 4);

-- Insert Product-Promotion relationships
INSERT INTO Product_Promotion (ProductId, PromotionId) VALUES 
(1, 1), (2, 1), (3, 1), -- Tiramisu c√≥ khuy·∫øn m√£i WELCOME10
(14, 2), (15, 2), (16, 2), -- C√† ph√™ c√≥ khuy·∫øn m√£i COMBO20
(21, 3), (22, 3); -- Matcha c√≥ khuy·∫øn m√£i WEEKEND15

-- ==========================================
-- COMPLETION MESSAGE
-- ==========================================

PRINT N'========================================';
PRINT N'DATABASE CREATED SUCCESSFULLY!';
PRINT N'========================================';
PRINT N'Database: QLStoreTrangMieng';
PRINT N'Categories: 10 lo·∫°i s·∫£n ph·∫©m';
PRINT N'Products: 28 s·∫£n ph·∫©m v·ªõi ·∫£nh th·ª±c t·∫ø';
PRINT N'Payment Methods: 5 ph∆∞∆°ng th·ª©c';
PRINT N'Sample Orders: 2 ƒë∆°n h√†ng m·∫´u';
PRINT N'========================================';
PRINT N'ADMIN ACCOUNT:';
PRINT N'Email: admin@trangmieng.com';
PRINT N'Password: admin123';
PRINT N'========================================';
PRINT N'CUSTOMER ACCOUNTS:';
PRINT N'Email: customer1@gmail.com / 123456';
PRINT N'Email: customer2@gmail.com / 123456';
PRINT N'========================================';
PRINT N'FEATURES READY:';
PRINT N'‚úÖ Product Management';
PRINT N'‚úÖ Order Management'; 
PRINT N'‚úÖ Cart System (Session-based)';
PRINT N'‚úÖ User Authentication';
PRINT N'‚úÖ Admin Panel';
PRINT N'üöß Payment Integration (MoMo)';
PRINT N'üöß Review System';
PRINT N'üöß Dashboard Analytics';
PRINT N'========================================';